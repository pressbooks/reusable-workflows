name: Update POT file üåê

on:
  workflow_call:
    inputs:
      domain:
        type: string
        description: 'Text domain for the POT file'
        required: true
      slug:
        type: string
        description: 'Project slug'
        required: true
      package_name:
        type: string
        description: 'Package name for the header in the POT file'
        required: true
      headers:
        type: string
        description: 'Additional headers in JSON format'
        required: true
      pull_request_number:
        type: number
        description: 'Pull request number'
        required: true
    secrets:
      PAT_FOR_GITHUB_ACTIONS:
        description: 'Personal Access Token for GitHub Actions'
        required: true

jobs:
  update-pot:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_FOR_GITHUB_ACTIONS }}
          
      - name: Get pull request information
        id: get_pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ inputs.pull_request_number }}
            });
            
            const labels = pr.data.labels.map(label => label.name).join(',');
            const headRef = pr.data.head.ref;
            const headSha = pr.data.head.sha;
            
            console.log('Pull request labels:', labels);
            console.log('Head ref:', headRef);
            console.log('Head SHA:', headSha);
            
            core.setOutput('labels', labels);
            core.setOutput('head_ref', headRef);
            core.setOutput('head_sha', headSha);
            
            // Check if this is an autorelease PR
            const isAutorelease = labels.includes('autorelease');
            core.setOutput('skip_pot_update', isAutorelease);
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_FOR_GITHUB_ACTIONS }}
          
      - name: Set up PHP
        if: steps.get_pr_info.outputs.skip_pot_update == 'false'
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: wp-cli/wp-cli-bundle
          
      - name: Checkout PR branch
        if: steps.get_pr_info.outputs.skip_pot_update == 'false'
        run: |
          git checkout ${{ steps.get_pr_info.outputs.head_ref }}
          
      - name: Update POT file
        if: steps.get_pr_info.outputs.skip_pot_update == 'false'
        run: |
          mkdir -p languages
          wp i18n make-pot . languages/${{ github.event.repository.name }}.pot \
            --domain=${{ inputs.domain }} \
            --slug=${{ inputs.slug }} \
            --package-name="${{ inputs.package_name }}" \
            --headers='${{ inputs.headers }}'
            
      - name: Configure Git
        if: steps.get_pr_info.outputs.skip_pot_update == 'false'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          
      - name: Check for changes and commit
        if: steps.get_pr_info.outputs.skip_pot_update == 'false'
        run: |
          git add languages/${{ github.event.repository.name }}.pot
          
          if git diff --staged --quiet; then
            echo "No changes to POT file"
          else
            echo "POT file has changes, committing..."
            
            # Get the latest commit message
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            
            # Check if the last commit was already a POT update
            if [[ "$LAST_COMMIT_MSG" == *"Update POT file"* ]]; then
              echo "Amending existing POT update commit"
              git commit --amend --no-edit
            else
              echo "Creating new POT update commit"
              git commit -m "Update POT file for translations"
            fi
            
            git push origin ${{ steps.get_pr_info.outputs.head_ref }} --force-with-lease
          fi
          
      - name: Add comment to PR
        if: steps.get_pr_info.outputs.skip_pot_update == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if POT file was updated
            const { execSync } = require('child_process');
            
            try {
              const potPath = `languages/${context.repo.repo}.pot`;
              const result = execSync(`git log -1 --name-only --pretty=format: | grep -q "${potPath}" && echo "updated" || echo "no_changes"`, { encoding: 'utf8' }).trim();
              
              if (result === 'updated') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: ${{ inputs.pull_request_number }},
                  body: 'üåê POT file has been automatically updated for translations.'
                });
              }
            } catch (error) {
              console.log('Could not determine POT file status or add comment:', error.message);
            }
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_FOR_GITHUB_ACTIONS }}